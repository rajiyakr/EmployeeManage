<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - EmployeeManage</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">

    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="/css/adminlte.css" />

    <!-- OverlayScrollbars -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"
          crossorigin="anonymous" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
          crossorigin="anonymous" />

    <!-- ApexCharts -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
          crossorigin="anonymous" />

</head>
<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">

    <div class="app-wrapper">
        <partial name="_TopNavbar.cshtml" />
        <partial name="_Sidebar.cshtml" />

        <main role="main" class="pb-3">
            @RenderBody()
        </main>

        <partial name="_Footer.cshtml" />
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- OverlayScrollbars JS -->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js" crossorigin="anonymous"></script>

    <!-- AdminLTE JS -->
    <script src="/js/adminlte.js"></script>

    <!-- ApexCharts JS -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" crossorigin="anonymous"></script>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        window.currentUserName = '@User.Identity.Name';

        document.addEventListener("DOMContentLoaded", function () {
            const messageListContainer = document.getElementById("messageListContainer");
            const dropdownToggle = document.querySelector('.nav-link[data-bs-toggle="dropdown"]');

            // SignalR setup
            if (!window.connection) {
                window.connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chathub")
                    .build();

                window.connection.start()
                    .then(() => console.log("SignalR connected as:", window.currentUserName))
                    .catch(err => console.error("SignalR connection failed:", err.toString()));
            }

            // Function to load last 10 received messages
            async function loadReceivedMessages() {
                try {
                    const response = await fetch('/Chat?handler=ReceivedMessages');
                    const messages = await response.json();

                    messageListContainer.innerHTML = '';

                    if (messages.length === 0) {
                        messageListContainer.innerHTML = '<p class="dropdown-item text-center text-muted">No messages</p>';
                        return;
                    }

                    messages.forEach(msg => {
                        const li = document.createElement('p');
                        li.classList.add('dropdown-item');

                        const senderName = msg.sender === window.currentUserName ? 'You' : msg.sender;
                        li.textContent = `${senderName}: ${msg.content}`;

                        if (!msg.isRead) {
                            li.style.fontWeight = 'bold';
                            li.style.backgroundColor = '#f0f8ff';
                        }

                        messageListContainer.appendChild(li);
                    });

                    // Update badge count for unread messages
                    const unreadCount = messages.filter(m => !m.isRead).length;
                    const badge = document.getElementById("navbar-message-badge");
                    badge.textContent = unreadCount > 0 ? unreadCount : '';
                } catch (err) {
                    console.error("Error loading messages:", err);
                }
            }

            // Load messages on page load
            loadReceivedMessages();

            // Reload messages each time dropdown is opened
            dropdownToggle.addEventListener('click', () => {
                loadReceivedMessages();
            });
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false) 
</body> 
</html>