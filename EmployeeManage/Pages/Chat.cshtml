@page
@model EmployeeManage.Pages.ChatModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Chat";
}

<h2 class="text-3xl font-extrabold text-indigo-700 mb-6">Real-Time Chat</h2>

<div class="max-w-xl mx-auto p-4 bg-white shadow-lg rounded-xl">
    <div class="h-80 overflow-y-auto border border-gray-200 p-3 mb-4 rounded-lg bg-gray-50">
        <ul id="messagesList" class="space-y-2"></ul>
    </div>

    <div class="flex flex-col space-y-3">
        <input type="text" id="receiver" placeholder="Receiver Username"
               class="p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm" />

        <div class="flex space-x-3">
            <input type="text" id="messageInput" placeholder="Type your message here..."
                   class="flex-grow p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm" />
            <button id="sendButton"
                    class="px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">
                Send
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.currentUserName = '@User.Identity.Name';

        // Load existing messages on page load
        async function loadMessages() {
            const response = await fetch('/Chat?handler=AllMessages');
            const messages = await response.json();

            const messagesList = document.getElementById("messagesList");
            messagesList.innerHTML = '';

            messages.forEach(msg => {
                const li = document.createElement('li');
                const senderName = (msg.sender === currentUserName) ? 'You' : msg.sender;
                li.textContent = `${senderName}: ${msg.content}`;
                messagesList.appendChild(li);
            });

            messagesList.scrollTop = messagesList.scrollHeight;
        }

        loadMessages();

        document.addEventListener("DOMContentLoaded", function () {
            const messagesList = document.getElementById("messagesList");

            function registerReceiveMessage() {
                if (window.connection) {
                    window.connection.on("ReceiveMessage", (sender, message, sentAt) => {
                        const li = document.createElement("li");
                        li.className = "p-2 rounded-lg break-words";
                        li.style.backgroundColor = sender === window.currentUserName ? '#e0f7fa' : '#f0f4f8';
                        li.style.borderLeft = sender === window.currentUserName ? '4px solid #00bcd4' : '4px solid #90a4ae';

                        li.innerHTML = `<span class="font-bold">${sender === window.currentUserName ? 'You' : sender}</span>: ${message}
                                        <span class="text-xs text-gray-500 float-end">${sentAt}</span>`;

                        messagesList.appendChild(li);
                        messagesList.scrollTop = messagesList.scrollHeight;
                    });
                } else {
                    setTimeout(registerReceiveMessage, 100);
                }
            }

            registerReceiveMessage();

            document.getElementById("sendButton").addEventListener("click", () => {
                const receiver = document.getElementById("receiver").value.trim();
                const message = document.getElementById("messageInput").value.trim();
                if (!message) return;

                if (window.connection) {
                    window.connection.invoke("SendMessage", receiver, message)
                        .then(() => document.getElementById("messageInput").value = "")
                        .catch(err => console.error("SendMessage error:", err.toString()));
                }
            });
        });
    </script>
}

